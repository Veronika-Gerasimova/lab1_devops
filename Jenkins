pipeline {
    agent any

    environment {
        VENV_DIR = "${WORKSPACE}\\venv"
        FLASK_APP = "app.py"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'dev', url: 'https://github.com/Veronika-Gerasimova/lab1_devops.git'
            }
        }

        stage('Setup Python') {
            steps {
                bat """
                C:\\Users\\geras\\AppData\\Local\\Programs\\Python\\Python312\\python.exe -m venv %VENV_DIR%
                call %VENV_DIR%\\Scripts\\activate
                %VENV_DIR%\\Scripts\\pip install --upgrade pip
                %VENV_DIR%\\Scripts\\pip install -r requirements.txt
                """
            }
        }

        stage('Run Tests') {
            steps {
                bat """
                call %VENV_DIR%\\Scripts\\activate
                pytest test_app.py --maxfail=1 --disable-warnings
                """
            }
        }

        stage('Deploy Flask App') {
            steps {
                bat """
                call %VENV_DIR%\\Scripts\\activate
                if exist flask.pid (
                    for /f %%i in (flask.pid) do taskkill /PID %%i /F
                    del flask.pid
                )
                start /B python %FLASK_APP%
                """
            }
        }
    }

    post {
        success {
            echo 'Build, test, and deploy successful!'
        }
        failure {
            echo 'Build or tests failed!'
        }
    }
}
