pipeline {
    agent any

    environment {
        PY_BIN = "python"       
        VENV_DIR = "venv"       
    }

    options {
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checkout branch: ${env.BRANCH_NAME}"
                checkout scm
            }
        }

        stage('Quality Test') {
            steps {
                echo "Running quality checks..."
                bat """
                   %PY_BIN% -m venv %VENV_DIR%
                   call %VENV_DIR%\\Scripts\\activate
                   pip install --upgrade pip
                   pip install flake8
                   flake8 app.py test_app.py || exit 0
                """
            }
        }

        stage('Unit Test') {
            steps {
                echo "Running pytest..."
                bat """
                   call %VENV_DIR%\\Scripts\\activate
                   pip install flask pytest
                   if not exist reports mkdir reports
                   pytest --junitxml=reports\\junit.xml
                """
            }
            post {
                always {
                    junit 'reports/junit.xml'
                }
            }
        }

        stage('Rebuild / Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo "Deploying Flask app..."
                bat """
                   call %VENV_DIR%\\Scripts\\activate
                   echo Installing dependencies...
                   pip install -r requirements.txt || pip install flask pytest

                   echo Restarting application...
                   if exist flask.pid (
                       for /F %%i in (flask.pid) do taskkill /F /PID %%i || exit 0
                       del flask.pid
                   )

                   start /B %PY_BIN% app.py > flask.log 2>&1
                   echo %PROCESS_ID% > flask.pid
                """
            }
        }

        stage('Acceptance Tests') {
            when {
                branch 'main'
            }
            steps {
                echo "Checking if Flask app is up..."
                bat """
                   timeout /T 5 >nul
                   curl http://127.0.0.1:5000/ || exit 0
                """
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline finished SUCCESS"
        }
        failure {
            echo "❌ Pipeline FAILED"
        }
    }
}
